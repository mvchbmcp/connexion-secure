form.addEventListener('submit', async (e) => {
  e.preventDefault();
  messageDiv.textContent = '';
  messageDiv.style.color = 'red';

  const email = document.getElementById('email').value.trim();
  const oldPassword = document.getElementById('old-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;

  console.log("Étape 1 : Données collectées");

  if (newPassword !== confirmPassword) {
    messageDiv.textContent = "Les mots de passe ne correspondent pas.";
    return;
  }

  console.log("Étape 2 : Tentative de connexion…");

  const { data, error: loginError } = await supabase.auth.signInWithPassword({
    email,
    password: oldPassword
  });

  if (loginError || !data.session) {
    console.error("Échec connexion :", loginError);
    messageDiv.textContent = "Ancien mot de passe incorrect.";
    return;
  }

  console.log("Étape 3 : Connexion réussie, tentative de mise à jour…");

  const { error: updateError } = await supabase.auth.updateUser({
    password: newPassword
  });

  if (updateError) {
    console.error("Échec update :", updateError);
    messageDiv.textContent = "Erreur lors de la modification : " + updateError.message;
    return;
  }

  console.log("Étape 4 : Mot de passe modifié");

  messageDiv.style.color = 'green';
  messageDiv.textContent = "Mot de passe changé avec succès.";
  await supabase.auth.signOut();
  form.reset();
});
