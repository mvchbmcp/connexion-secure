<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://dwrropzvxdykvdiuvlnp.supabase.co';
  const supabaseKey = 'VOTRE_ANON_KEY'; // Ne mets jamais la clé service ici
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const form = document.getElementById('change-password-form');
  const messageDiv = document.getElementById('message');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    messageDiv.textContent = '';
    messageDiv.style.color = 'red';

    const email = document.getElementById('email').value.trim();
    const oldPassword = document.getElementById('old-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;

    if (newPassword !== confirmPassword) {
      messageDiv.textContent = "Les nouveaux mots de passe ne correspondent pas.";
      return;
    }

    // Étape 1 : Connexion
    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
      email,
      password: oldPassword,
    });

    if (signInError) {
      messageDiv.textContent = "Email ou ancien mot de passe incorrect.";
      return;
    }

    // Étape 2 : Mise à jour du mot de passe
    const { error: updateError } = await supabase.auth.updateUser({
      password: newPassword,
    });

    if (updateError) {
      messageDiv.textContent = "Erreur lors de la mise à jour : " + updateError.message;
      return;
    }

    messageDiv.style.color = 'green';
    messageDiv.textContent = "Mot de passe modifié avec succès !";

    // Déconnexion après modification
    await supabase.auth.signOut();
    form.reset();
  });
</script>
